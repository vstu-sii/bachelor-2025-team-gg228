# Отчёт по проекту «Поиск источников»

Ниже — описание выполненных работ простым языком, сгруппированное по 4 ролям из задания.

---

## 1) Fullstack (Frontend + Backend)

### Пользовательский сайт (UI/UX)

- Сделан современный интерфейс поиска источников:
  - ввод текста запроса **или** загрузка файла **PDF/DOCX**;
  - отображение списка источников с процентом совпадения;
  - настройка **порога совпадения в процентах** (слайдер + поле ввода);
  - переключатель «Улучшенный поиск» (включает/выключает переранжирование).
- Улучшено отображение результатов:
  - «цитаты» стали более связными: вместо обрезки первых N символов берётся окно текста вокруг совпадений и добавляется контекст соседних чанков (меньше “рваных” фрагментов).

### Скрытая панель управления

- Панель управления **не видна публично**:
  - кнопки/ссылки в публичном UI нет;
  - ссылка «Панель» появляется только если пользователь авторизован и имеет роль `admin`;
  - отдельный роут `/panel`.
- В панели реализовано:
  - загрузка документов‑источников (PDF/DOCX) в базу;
  - прогресс‑бар загрузки файла;
  - очистка file‑input после успешной загрузки;
  - список документов и удаление;
  - управление пользователями (создание, смена роли admin/user, включение/отключение аккаунта);
  - просмотр метрик (сводка + последние запросы).

### Backend (FastAPI)

- Реализованы API‑маршруты:
  - аутентификация (JWT): вход и регистрация;
  - профиль `/users/me`;
  - поиск `/search` (с порогом совпадения и опциональным rerank);
  - baseline‑поиск без реранкера (для сравнения);
  - административные маршруты для документов, пользователей и метрик.
- Обработка документов:
  - чтение PDF/DOCX, извлечение текста;
  - разбиение текста на чанки;
  - вычисление эмбеддингов;
  - запись метаданных в Postgres и векторов в Milvus.
- Исправлена проблема «слишком длинное имя файла»:
  - файлы сохраняются по схеме `UUID.ext` (например: `bb724ffb-62a2-48f7-b1b9-394fe352fe50.pdf`).

### Инфраструктура входа (Nginx)

- Nginx проксирует:
  - `/api/*` → backend;
  - всё остальное → frontend.

---

## 2) AI Engineer

### Baseline

- Базовый вариант поиска (baseline) — **векторный поиск по эмбеддингам**:
  - Milvus возвращает top‑K наиболее похожих чанков.
- Добавлен отдельный baseline‑маршрут (без реранкера), чтобы можно было сравнивать:
  - качество/релевантность;
  - задержки;
  - влияние модели на результат.

### «Своя модель» как реранкер (Reranker)

- Выбран самый простой и полезный формат “своей LLM” для проекта: **переранжирование источников**.
- Смысл: retrieval находит кандидатов, а модель (reranker) пересортировывает их так, чтобы наверху были самые релевантные.
- Это действительно улучшает функционал поиска и при этом проще, чем обучать большую генеративную модель.

### Маршруты модели и интеграция

- Реранкер вынесен в отдельный сервис (микросервис):
  - API `POST /rerank` принимает `query + candidates` и возвращает отсортированный список с `rerank_score`.
- В пользовательском UI добавлен переключатель «Улучшенный поиск»:
  - выключено → baseline;
  - включено → кандидаты дополнительно проходят реранкер.

### Первые метрики качества/экспериментов

- Подготовлены скрипты для экспериментов:
  - генерация датасета из вашей базы документов (из чанков);
  - обучение базовой модели‑классификатора (sequence classification);
  - оценка метрики `pairwise accuracy` (насколько часто positive выше negative).

---

## 3) MLOps

### Контейнеризация backend

- Backend упакован в Docker, запуск через `docker-compose`.
- Добавлен отдельный контейнер для rеранкера.
- Подняты необходимые инфраструктурные сервисы:
  - Postgres (метаданные),
  - Milvus (векторный индекс) + etcd + minio,
  - Nginx (единая точка входа).

### Langfuse

- Добавлен self‑hosted Langfuse‑стек в `docker-compose` (web/worker + clickhouse + redis + postgres + minio).
- В backend и в reranker добавлено **опциональное** трейсирование:
  - включается переменными окружения и ключами проекта Langfuse;
  - позволяет видеть трассы запросов поиска и вызовов реранкера.

### Grafana + Prometheus

- В backend добавлен endpoint `/metrics`.
- Подняты Prometheus и Grafana:
  - Prometheus собирает метрики с backend;
  - Grafana подключена к Prometheus и содержит готовый дашборд:
    - RPS поиска (baseline vs rerank),
    - p95 задержки поиска,
    - частота и задержка вызовов реранкера.

### GitHub Actions (CI)

- Добавлен workflow CI:
  - проверка, что backend и reranker компилируются (минимальная защита от синтаксических ошибок),
  - сборка frontend,
  - сборка Docker‑образов (гарантия, что проект билдится в чистом окружении).

---

## 4) SA/PO (System Analyst / Product Owner)

### 1. Итоги по требованиям

- Реализован сайт поиска источников по тексту/файлу.
- Реализована скрытая панель управления (не видна обычным пользователям).
- Добавлены аккаунты пользователей и управление ими.
- Добавлены метрики и наблюдаемость (Grafana/Prometheus) и трейсинг (Langfuse).
- Добавлен “свой ML‑компонент” (reranker) и baseline для сравнения.

### 2. Подтверждение архитектуры

Выбрана архитектура **Retrieval + (опционально) Rerank**:

- Postgres: пользователи, документы, чанки, события поиска.
- Milvus: векторный индекс чанков.
- Backend (FastAPI): парсинг PDF/DOCX, чанкинг, эмбеддинги, поиск, бизнес‑логика и авторизация.
- Reranker‑сервис: переранжирование top‑K кандидатов.
- Nginx: единая точка входа для фронта и API.

Архитектура масштабируемая: можно менять модели эмбеддингов/реранкера и добавлять более “умные” шаги без переделки всего приложения.

### 3. План следующего спринта

- Качество поиска:
  - улучшить чанкинг (по структуре документа);
  - хранить/выводить страницу PDF точнее;
  - подсветка совпадений в цитатах.
- ML:
  - собрать более качественную разметку (частично вручную);
  - сравнить baseline vs reranker по метрикам качества и задержкам.
- Продукт:
  - просмотр/скачивание исходников из панели;
  - журнал действий (кто что загрузил/удалил/искал).
- MLOps:
  - миграции БД через Alembic;
  - smoke‑тесты в CI.

### 4. Контроль интеграции

- Интеграция поиска:
  1) retrieval (Milvus) → 2) кандидаты → 3) (опционально) reranker → 4) выдача результатов.
- Интеграция observability:
  - Prometheus скрейпит `/metrics`, Grafana показывает дашборд;
  - Langfuse (если включён) показывает трейсы поиска и вызовов реранкера.
- Интеграция CI:
  - при пуше/PR проверяется, что проект компилируется и собирается.

