# Требования (v3)

Дата: 2025-12-24

## 1) Цель продукта

Сайт для поиска источников по введённому тексту или загруженному документу (PDF/DOCX) на базе векторного поиска, с опциональным переранжированием результатов (reranker).

## 2) Роли и доступ

- **Гость**: может искать по тексту/файлу (если политика проекта допускает публичный поиск).
- **Пользователь** (`user`): поиск + личный профиль.
- **Администратор** (`admin`): доступ к панели управления (`/panel`) и админ‑функциям.

## 3) Область (scope)

### In-scope (MVP)

- Поиск источников по тексту или документу (PDF/DOCX).
- Порог релевантности (в процентах) для фильтрации/среза результатов.
- Выдача результатов с:
  - названием/идентификатором источника,
  - процентом совпадения (на основе similarity),
  - цитатой/фрагментом с контекстом.
- Опциональный режим **“Улучшенный поиск”** (rerank on/off).
- Панель администратора:
  - загрузка и удаление источников,
  - список документов,
  - управление пользователями (роль, активность),
  - просмотр метрик запросов.
- Наблюдаемость:
  - метрики Prometheus,
  - дашборды Grafana,
  - (опционально) трейсинг Langfuse.
- Контейнеризация и запуск через `docker compose`.

### Out-of-scope (пока)

- “Полноценная” генеративная LLM‑ответка (RAG‑чат) поверх источников.
- Гранулярные права на документы (ACL на уровне источника/организации).
- Мультиязычность интерфейса и моделей.

## 4) Функциональные требования

### Поиск

- **FR-1**: Система принимает запрос как:
  - текстовое поле, или
  - загрузка PDF/DOCX (извлечение текста на backend).
- **FR-2**: Система выполняет retrieval по эмбеддингам и возвращает top‑K кандидатов.
- **FR-3**: Система поддерживает фильтр `min_similarity_percent` (0–100).
- **FR-4**: Система поддерживает режимы:
  - baseline (без reranker),
  - rerank (переранжирование кандидатов).
- **FR-5**: Результат поиска содержит список источников с ранжированием, score, цитатой (excerpt) и метаданными источника.

### Загрузка/индексация источников

- **FR-6**: Администратор может загрузить PDF/DOCX в систему.
- **FR-7**: Backend извлекает текст, режет на чанки, считает эмбеддинги, сохраняет:
  - метаданные и чанки в Postgres,
  - эмбеддинги в Milvus.
- **FR-8**: Имена файлов при сохранении не должны приводить к ошибке “слишком длинное имя файла”; хранение файла использует безопасный идентификатор (UUID).

### Пользователи и безопасность доступа

- **FR-9**: Регистрация/логин, выдача JWT.
- **FR-10**: Эндпоинты админ‑панели доступны только роли `admin`.
- **FR-11**: Пользователь может получать свой профиль (`/users/me`).

### Метрики и аудит

- **FR-12**: Система считает метрики запросов поиска (baseline vs rerank) и времени ответа.
- **FR-13**: Администратор видит сводку метрик и последние события поиска.

## 5) Нефункциональные требования (NFR)

### Качество поиска (ML/IR)

- **NFR-1 (offline)**: reranker после обучения должен достигать `pairwise accuracy >= 0.60` на репрезентативной выборке (>= 2000 пар) из домена документов.
- **NFR-2 (online)**: включение rerank не должно ухудшать качество на контрольном наборе кейсов (минимум 20 сценариев) относительно baseline.

### Производительность

- **NFR-3**: p95 latency `/search` baseline `<= 1.5s` при top‑K=20 (без учёта первого холодного старта).
- **NFR-4**: p95 latency `/search` rerank `<= 2.5s` при top‑K=20.
- **NFR-5**: Сервис должен выдерживать минимум 5 RPS на демо‑окружении без деградации >2x от p95.

### Надёжность/эксплуатация

- **NFR-6**: `docker compose up --build` поднимает стек без ручных правок.
- **NFR-7**: У сервисов есть `/health` (для backend и reranker) и healthcheck в compose/инфре.

### Безопасность

- **NFR-8**: Пароли хранятся только в хэшированном виде (не логируются).
- **NFR-9**: Ограничение размера входного файла (минимум на уровне nginx/backend), отказоустойчивые таймауты на обработку.
- **NFR-10**: Секреты не должны храниться в репозитории; только через `.env`/секрет‑хранилище.

### Frontend сборка

- **NFR-11**: Для релиза должен быть production‑режим сборки и раздачи статики (не только dev‑server).

## 6) North Star Metric (NSM) и метрики продукта

### NSM (предлагаемая)

**Успешные поисковые сессии**, где пользователь получил минимум 1 результат выше порога и не столкнулся с ошибкой (4xx/5xx), за 7 дней.

### Supporting metrics

- RPS поиска (baseline vs rerank).
- p95/p99 latency поиска (baseline vs rerank).
- Доля пустых выдач (0 результатов) при фиксированном пороге.
- Доля ошибок (4xx/5xx) на поиске и загрузке.
- (если добавим события) клики/открытия источника из выдачи.

## 7) Definition of Done (DoD) для изменений

- Проходит сборка/проверки:
  - Python `compileall`,
  - frontend `vite build`,
  - (по возможности) docker build.
- Есть smoke‑прогон сценария:
  - поднять compose,
  - загрузить 1 документ,
  - выполнить 1 поиск (baseline и rerank),
  - получить результаты и метрики.
- Обновлены документы: требования/план/отчёт, если изменялась функциональность или метрики.

## 8) Изменения v3 (после тестов/ревью)

- Зафиксированы минимальные целевые ориентиры по качеству reranker и по latency.
- Добавлены требования на smoke/e2e‑прогоны как часть DoD.
- Явно выделено требование production‑сборки/раздачи фронтенда для релиза.
